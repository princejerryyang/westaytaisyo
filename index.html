<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>消耗品库存记录表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
      background: #f5f5f7;
      color: #111827;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
      margin-bottom: 16px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .field {
      flex: 1 1 90px;
      min-width: 90px;
    }
    .field label {
      display: block;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .field input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      outline: none;
    }
    .field input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }
    button.primary {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 18px;
      flex-shrink: 0;
    }
    button.primary:active { opacity: 0.8; }

    .table-wrapper {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead {
      background: #f3f4f6;
    }
    th, td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      color: #4b5563;
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 1;
    }
    tr.low-stock {
      background: #fef2f2;
      color: #b91c1c;
    }
    tr.low-stock td.stock {
      font-weight: 700;
    }
    .qty-input {
      width: 72px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }
    .btn-small {
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      background: #10b981;
      color: #ffffff;
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 2px;
    }
    .btn-small.secondary {
      background: #6b7280;
    }
    .btn-small.danger {
      background: #ef4444;
    }
    .btn-small:active {
      opacity: 0.85;
    }
    .footer-note {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 8px;
    }

    @media (max-width: 600px) {
      .app { padding: 8px; }
      h1 { font-size: 1.2rem; }
      .card { padding: 10px 10px; }
      table { border-collapse: separate; border-spacing: 0 8px; }
      tr { border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
      th, td { padding: 6px 4px; font-size: 0.8rem; }
      td:nth-child(1) { text-align: left; font-weight: 600; }
      td:nth-child(5) { text-align: left; }
      .btn-small { width: 46%; margin: 4px 2% 2px; }
      .qty-input { width: 72px; }
    }
      .card { padding: 10px 10px; }
      th, td { padding: 6px 4px; }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>消耗品库存记录表</h1>
  <div class="subtitle">
    库存≤安全库存时标红，提醒采购。
  </div>

  <div class="card">
    <div class="form-row">
      <div class="field">
        <label>品名（例如：卷纸）</label>
        <input id="nameInput" type="text" placeholder="卷纸 / 抽纸 / 洗衣液…" />
      </div>
      <div class="field">
        <label>当前库存数量</label>
        <input id="stockInput" type="number" min="0" placeholder="例如：50" />
      </div>
      <div class="field">
        <label>安全库存（提醒阈值）</label>
        <input id="thresholdInput" type="number" min="0" placeholder="例如：10" />
      </div>
      <button class="primary" id="addBtn">新增/更新品项</button>
    </div>
    <div class="footer-note">
      同名品项会被视为同一行，填写后会“更新”该品项的库存与安全库存。
    </div>
  </div>

  <div class="card">
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>品名</th>
          <th>当前库存</th>
          <th>安全库存</th>
          <th>出库</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="footer-note">
      每次从库房拿东西时，只需要在“确认出库”里填数量 → 点“确认出库”。库存低于安全库存时，该行会变红，表示需要尽快采购。
    </div>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbznMoykHk5eg3v7JIXIohF8Kr4TvyJUcf7jEGGdxfCFbhqTeNt9N7IA2g3PYxjheamntg/exec';

  let items = [];

  function loadItems() {
    fetch(API_URL + '?t=' + Date.now())
      .then(function(res) { return res.json(); })
      .then(function(data) {
        items = data.items || [];
        if (items.length === 0) {
          items = [
            { name: '卷纸', stock: 50, threshold: 10 },
            { name: '抽纸', stock: 20, threshold: 5 },
            { name: '垃圾袋', stock: 10, threshold: 5 }
          ];
          syncItems();
        }
        renderTable();
      })
      .catch(function() {
        alert('读取库存数据失败，请稍后重试');
        items = [];
        renderTable();
      });
  }

  function syncItems() {
    fetch(API_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: items })
    });
  }

  function addOrUpdateItem() {
    var name = document.getElementById('nameInput').value.trim();
    var stockVal = document.getElementById('stockInput').value;
    var thresholdVal = document.getElementById('thresholdInput').value;

    if (!name) {
      alert('请先填写品名');
      return;
    }
    var stock = Number(stockVal);
    var threshold = Number(thresholdVal);

    if (isNaN(stock) || stock < 0) {
      alert('请填写正确的库存数量');
      return;
    }
    if (isNaN(threshold) || threshold < 0) {
      alert('请填写正确的安全库存数量');
      return;
    }

    var existing = items.find(function(i) { return i.name === name; });
    if (existing) {
      existing.stock = stock;
      existing.threshold = threshold;
    } else {
      items.push({ name: name, stock: stock, threshold: threshold });
    }

    syncItems();
    renderTable();

    document.getElementById('nameInput').value = '';
    document.getElementById('stockInput').value = '';
    document.getElementById('thresholdInput').value = '';
  }

  function deleteItem(name) {
    if (!confirm('确定要删除「' + name + '」这个品项吗？')) return;
    items = items.filter(function(i) { return i.name !== name; });
    syncItems();
    renderTable();
  }

  function renameItem(oldName) {
    var newName = prompt('请输入新的品名：', oldName);
    if (newName === null) return;
    newName = newName.trim();
    if (!newName) {
      alert('品名不能为空');
      return;
    }
    var exists = items.some(function(i) {
      return i.name === newName && i.name !== oldName;
    });
    if (exists) {
      alert('已经存在同名品项，请使用其他名称。');
      return;
    }
    var target = items.find(function(i) { return i.name === oldName; });
    if (!target) return;
    target.name = newName;
    syncItems();
    renderTable();
  }

  function renderTable() {
    var tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    if (items.length === 0) {
      var trEmpty = document.createElement('tr');
      var tdEmpty = document.createElement('td');
      tdEmpty.colSpan = 5;
      tdEmpty.textContent = '尚无品项，请先在上方添加。';
      tdEmpty.style.color = '#9ca3af';
      trEmpty.appendChild(tdEmpty);
      tbody.appendChild(trEmpty);
      return;
    }

    items.forEach(function(item) {
      var tr = document.createElement('tr');
      if (item.stock <= item.threshold) {
        tr.classList.add('low-stock');
      }

      var tdName = document.createElement('td');
      tdName.textContent = item.name;

      var tdStock = document.createElement('td');
      tdStock.textContent = '库存：' + item.stock;
      tdStock.classList.add('stock');

      var tdThr = document.createElement('td');
      tdThr.textContent = '安全：' + item.threshold;

      var tdTake = document.createElement('td');
      var input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.placeholder = '数量';
      input.className = 'qty-input';
      tdTake.appendChild(input);

      var tdAction = document.createElement('td');

      var btnTake = document.createElement('button');
      btnTake.className = 'btn-small';
      btnTake.textContent = '出库';
      btnTake.onclick = function() {
        var val = Number(input.value);
        if (!val || val <= 0) return;
        if (val > item.stock) {
          alert('出库数量大于当前库存，请确认。');
          return;
        }
        item.stock -= val;
        input.value = '';
        syncItems();
        renderTable();
      };

      var btnReset = document.createElement('button');
      btnReset.className = 'btn-small secondary';
      btnReset.textContent = '入库';
      btnReset.style.marginLeft = '4px';
      btnReset.onclick = function() {
        if (tdAction.querySelector('.edit-stock-wrapper')) {
          var inInputExist = tdAction.querySelector('.stock-in-input');
          if (inInputExist) inInputExist.focus();
          return;
        }

        var wrapper = document.createElement('div');
        wrapper.className = 'edit-stock-wrapper';
        wrapper.style.marginTop = '6px';
        wrapper.style.borderTop = '1px dashed #e5e7eb';
        wrapper.style.paddingTop = '4px';

        var rowIn = document.createElement('div');
        rowIn.style.marginTop = '2px';

        var labelIn = document.createElement('span');
        labelIn.textContent = '入库数量:';
        labelIn.style.fontSize = '0.75rem';
        labelIn.style.marginRight = '4px';

        var inInput2 = document.createElement('input');
        inInput2.type = 'number';
        inInput2.min = '0';
        inInput2.placeholder = '数量';
        inInput2.className = 'qty-input stock-in-input';
        inInput2.style.width = '68px';

        var inBtn = document.createElement('button');
        inBtn.textContent = '入库';
        inBtn.className = 'btn-small';
        inBtn.style.marginLeft = '4px';
        inBtn.onclick = function() {
          var addVal = Number(inInput2.value);
          if (!addVal || addVal <= 0) return;
          if (isNaN(addVal)) {
            alert('请输入正确的数字');
            return;
          }
          item.stock += addVal;
          syncItems();
          renderTable();
        };

        rowIn.appendChild(labelIn);
        rowIn.appendChild(inInput2);
        rowIn.appendChild(inBtn);

        var rowThr = document.createElement('div');
        rowThr.style.marginTop = '4px';

        var labelThr = document.createElement('span');
        labelThr.textContent = '安全库存:';
        labelThr.style.fontSize = '0.75rem';
        labelThr.style.marginRight = '4px';

        var thrInput = document.createElement('input');
        thrInput.type = 'number';
        thrInput.min = '0';
        thrInput.value = item.threshold;
        thrInput.className = 'qty-input';
        thrInput.style.width = '68px';

        var thrBtn = document.createElement('button');
        thrBtn.textContent = '修改安全库存';
        thrBtn.className = 'btn-small';
        thrBtn.style.marginLeft = '4px';
        thrBtn.onclick = function() {
          var newThr = Number(thrInput.value);
          if (isNaN(newThr) || newThr < 0) {
            alert('请输入正确的数字');
            return;
          }
          item.threshold = newThr;
          syncItems();
          renderTable();
        };

        rowThr.appendChild(labelThr);
        rowThr.appendChild(thrInput);
        rowThr.appendChild(thrBtn);

        var cancelRow = document.createElement('div');
        cancelRow.style.marginTop = '4px';
        var cancelBtn = document.createElement('button');
        cancelBtn.textContent = '关闭';
        cancelBtn.className = 'btn-small secondary';
        cancelBtn.onclick = function() {
          wrapper.remove();
        };
        cancelRow.appendChild(cancelBtn);

        wrapper.appendChild(rowIn);
        wrapper.appendChild(rowThr);
        wrapper.appendChild(cancelRow);
        tdAction.appendChild(wrapper);
        inInput2.focus();
      };

      var btnRename = document.createElement('button');
      btnRename.className = 'btn-small secondary';
      btnRename.textContent = '改名';
      btnRename.style.marginLeft = '4px';
      btnRename.onclick = function() {
        renameItem(item.name);
      };

      var btnDelete = document.createElement('button');
      btnDelete.className = 'btn-small danger';
      btnDelete.textContent = '删除';
      btnDelete.style.marginLeft = '4px';
      btnDelete.onclick = function() {
        deleteItem(item.name);
      };

      tdAction.appendChild(btnTake);
      tdAction.appendChild(btnReset);
      tdAction.appendChild(btnRename);
      tdAction.appendChild(btnDelete);

      tr.appendChild(tdName);
      tr.appendChild(tdStock);
      tr.appendChild(tdThr);
      tr.appendChild(tdTake);
      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    });
  }

  document.getElementById('addBtn').addEventListener('click', addOrUpdateItem);
  setInterval(loadItems, 10000);
  loadItems();
</script>
</body>
</html>
